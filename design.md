# ZenTime アプリケーション設計書

## 1. 概要

**ZenTime**は、チーム向けのモダンでシンプルな勤怠管理および日報アプリケーションです。従業員は自身の労働時間と日々の業務進捗を記録でき、管理者はユーザー管理、全従業員の勤怠状況の監督、集計されたレポートの閲覧が可能です。

### 1.1. コア機能

- **認証**: メールアドレスとパスワードによるログイン機能。
- **勤怠打刻**: 日々の労働時間（開始・終了時刻、休憩時間）をフォームで入力。
- **勤怠履歴**: カレンダー形式で過去の勤怠記録、日々の収益（棒グラフ）、月間収益目標の進捗（ドーナツグラフ）を可視化。
- **日報**: その日の業務内容をテキストで報告・一覧表示。
- **管理者機能**:
  - **ダッシュボード**: 全従業員の労働時間や給与支払額のサマリーを表示。
  - **ユーザー管理**: 従業員の追加、編集、削除。
  - **給与計算**: 月ごとの全従業員の労働時間と給与を一覧表示。

### 1.2. ターゲットユーザー

1.  **一般ユーザー (従業員)**: 自身の勤怠と日報を記録し、給与の進捗を確認する。
2.  **管理者 (マネージャー/人事)**: 全従業員のデータを監督・管理し、全体の状況を把握する。

## 2. 技術スタックとファイル構造

- **フレームワーク**: React 19, TypeScript
- **スタイリング**: Tailwind CSS (CDN)
- **ルーティング**: `react-router-dom` (HashRouter)
- **状態管理**: React Context API (`AuthContext`, `DataContext`)
- **グラフ描画**: `recharts`
- **データ**: モックデータを `constants.ts` にて管理 (バックエンドなし)

### 2.1. ファイル構造

```
/
├── index.html            # メインHTMLファイル
├── index.tsx             # Reactアプリケーションのエントリポイント
├── metadata.json         # アプリケーションのメタデータ
├── App.tsx               # メインコンポーネント、ルーティングとレイアウトを管理
├── types.ts              # グローバルなTypeScriptの型定義
├── constants.ts          # モックデータ (ユーザー、勤怠記録)
│
├── components/
│   ├── ui/               # 再利用可能なUIコンポーネント
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   └── Input.tsx
│   ├── Login.tsx         # ログインページ
│   ├── Header.tsx        # 全ページ共通のヘッダー
│   ├── Sidebar.tsx       # ナビゲーション用のサイドバー
│   ├── TimeEntry.tsx     # 勤怠入力フォーム
│   ├── AttendanceHistory.tsx # 勤怠履歴・収益グラフページ
│   ├── DailyReports.tsx  # 全員の日報一覧ページ
│   │
│   └── admin/            # 管理者専用コンポーネント
│       ├── AdminDashboard.tsx
│       ├── UserManagement.tsx
│       └── Payroll.tsx
│
└── context/
    ├── AuthContext.tsx   # 認証状態の管理 (localStorageで永続化)
    └── DataContext.tsx   # アプリケーション全体のデータ管理
```

## 3. デザインシステム

### 3.1. カラーパレット

- **Primary**: `blue` (Tailwind CSS の`primary`として拡張) - アクションボタン、アクティブな UI 要素、グラフの主要な色として使用。
- **Slate**: `slate` - 背景、テキスト、ボーダーなど、UI の基本色として使用。
- **White**: `white` - カードの背景など、クリーンな印象を与えるために使用。
- **Red**: `red-600` - 削除ボタンなどの破壊的なアクションに使用。
- **Green**: `green-100`, `green-800` - 「User」ロールのバッジなど、ポジティブな状態表示に使用。

### 3.2. レイアウトとスペーシング

- **基本レイアウト**: Flexbox と Grid を主体とした 2 カラムレイアウト（サイドバー + メインコンテンツ）。
- **レスポンシブ**: Tailwind のブレークポイント (`sm:`, `md:`, `lg:`) を使用して、モバイルからデスクトップまで対応。
- **スペーシング**: Tailwind のユーティリティクラス（`p-4`, `space-y-6`など）に基づき、一貫した余白を確保。

### 3.3. タイポグラフィ

- **フォント**: `font-sans` (デフォルトのサンセリフ体)
- **サイズと太さ**: `text-sm`, `text-lg`, `font-semibold`, `font-bold` などのユーティリティクラスで階層を表現。

### 3.4. アイコン

- すべてのアイコンは、メンテナンス性とスタイルの適用しやすさを考慮し、インライン SVG としてコンポーネント内に定義。

## 4. コンポーネント設計

### 4.1. `Login.tsx`

- **目的**: ユーザー認証を行う。
- **デザイン**:
  - 画面中央に配置された`Card`コンポーネント内にフォームを配置。
  - アプリ名「ZenTime」を大きく表示。
  - メールとパスワードの`Input`フィールド。
  - 青色の`Button`でログインを実行。
  - テスト用のログイン情報を表示し、操作を補助。
- **機能**:
  - `DataContext`内のモックユーザーと照合。
  - 成功時: `AuthContext`を更新し、メインページへリダイレクト。
  - 失敗時: エラーメッセージを表示。

### 4.2. `Sidebar.tsx`

- **目的**: アプリケーション内の主要ページへのナビゲーションを提供する。
- **デザイン**:
  - 画面左側に固定幅で表示される垂直バー。
  - 上部に「ZenTime」ロゴ。
  - `NavLink`を使用し、現在地がハイライトされる（背景色と文字色が変化）。
  - 管理者ユーザーの場合のみ、「Admin」セクションが表示される。
- **機能**: ユーザーの役割（`Role`）に応じて表示するメニュー項目を動的に変更。

### 4.3. `Header.tsx`

- **目的**: 現在のページタイトルとユーザー情報、ログアウト機能を提供する。
- **デザイン**:
  - メインコンテンツエリアの上部に配置される水平バー。
  - 左側にページタイトル、右側にユーザー名とログアウトボタンを配置。
- **機能**: `useLocation`フックから現在のパスを取得し、対応するページタイトルを動的に表示。

### 4.4. `TimeEntry.tsx`

- **目的**: ユーザーが日々の勤怠と業務報告を入力する。
- **デザイン**:
  - 単一の`Card`内に整理されたフォーム。
  - 日付、開始・終了時刻、休憩時間を`Input`で入力。
  - 業務報告は複数行入力可能な`textarea`を使用。
- **機能**:
  - 送信後、`DataContext`に勤怠記録を追加。
  - フォームをリセットし、一時的な成功メッセージを表示してユーザーにフィードバック。

### 4.5. `AttendanceHistory.tsx`

- **目的**: ユーザーが自身の勤怠履歴と収益状況を確認する。管理者は全ユーザー分を閲覧可能。
- **デザイン**: 複数の`Card`で構成される情報密度の高いページ。
  1.  **コントロールとサマリーカード**:
      - **上部**: 月移動ナビゲーション。管理者向けに従業員選択ドロップダウン。
      - **下部 (Grid レイアウト)**:
        - **左側**: `recharts`の`PieChart`を使用したドーナツグラフ。月間目標に対する達成率をパーセンテージで表示。達成済みは青、未達分は薄いグレーで表現。
        - **右側**: 現在の累積収益と目標金額をテキストで表示。目標金額は`Input`で変更可能。
  2.  **日次収益グラフカード**:
      - `recharts`の`BarChart`を使用し、日々の収益を棒グラフで可視化。
      - Y 軸は「¥ 〇〇 k」形式でフォーマットし、見やすさを向上。
  3.  **勤怠記録テーブルカード**:
      - 日付、時間、休憩、労働時間、日給を一覧表示。
      - 管理者には各行に「編集」ボタンが表示され、クリックすると行内編集が可能になる。
- **機能**:
  - 選択されたユーザーと月に基づいて、すべてのデータ（グラフ、表）を動的にフィルタリング・計算。
  - `useMemo`フックを多用し、再計算のパフォーマンスを最適化。

### 4.6. `DailyReports.tsx`

- **目的**: 全ユーザーが提出した日報を時系列で閲覧する。
- **デザイン**:
  - `Card`を縦に並べたフィード形式のレイアウト。
  - 各カードには報告者名、日付、報告内容を表示。
- **機能**: `attendanceRecords`を日付の降順にソートして表示。

### 4.7. `admin/AdminDashboard.tsx`

- **目的**: 管理者が組織全体の主要な業績指標を一目で把握する。
- **デザイン**:
  - **上段**: 3 つの`Card`にサマリー情報（総労働時間、総給与支払額、アクティブ従業員数）を表示。
  - **下段**: 2 つの`Card`にグラフ（従業員別の総労働時間、従業員別の給与額）を表示。
- **機能**: `DataContext`から全ユーザーのデータを集計し、組織全体のパフォーマンスを可視化。

### 4.8. `admin/UserManagement.tsx`

- **目的**: 管理者が従業員アカウントを管理（CRUD）する。
- **デザイン**:
  - 「新規ユーザー追加」ボタンでフォームの表示/非表示を切り替え。
  - フォーム(`UserForm`)はユーザーの追加・編集に使用。給与体系に応じてラベルが動的に変化。
  - 全ユーザーをテーブルで一覧表示。役割（Role）は色付きのバッジで表現。
- **機能**: `DataContext`が提供する`addUser`, `updateUser`, `deleteUser`関数と連携し、ユーザー情報を操作。

### 4.9. `admin/Payroll.tsx`

- **目的**: 管理者が月ごとの給与支払い状況を確認する。
- **デザイン**:
  - **上部カード**: 月移動ナビゲーションと、その月の給与支払い総額を表示。
  - **テーブルカード**: 従業員ごとに、その月の労働時間と計算された給与を一覧表示。
- **機能**:
  - 選択された月に基づいて、各従業員の給与を計算。時給制と月給制の両方に対応。
  - 全従業員の給与を合計し、その月の総支払額を算出。

## 5. 状態管理とデータフロー

アプリケーションの状態は、React Context API を用いて 2 つのコンテキストで管理されています。

### 5.1. `AuthContext.tsx`

- **責務**: ユーザーの認証状態を管理する。
- **提供する状態**:
  - `user`: ログイン中のユーザーオブジェクト (`User | null`)。
- **提供する関数**:
  - `login(user)`: ユーザーオブジェクトを受け取り、state を更新し、`localStorage`にユーザー情報を保存する。
  - `logout()`: state を`null`に更新し、`localStorage`からユーザー情報を削除する。
- **永続化**: `localStorage`を利用することで、ブラウザをリロードしてもログイン状態が維持される。

### 5.2. `DataContext.tsx`

- **責務**: アプリケーションのコアデータ（ユーザーリスト、勤怠記録）を管理する。
- **提供する状態**:
  - `users`: 全ユーザーのリスト (`User[]`)。
  - `attendanceRecords`: 全勤怠記録のリスト (`AttendanceRecord[]`)。
- **提供する関数 (CRUD 操作)**:
  - `addUser`, `updateUser`, `deleteUser`
  - `addAttendanceRecord`, `updateAttendanceRecord`
- **データフロー**:
  1.  アプリケーションの最上位 (`App.tsx`) で `DataProvider` がラップされ、全コンポーネントがデータにアクセス可能になる。
  2.  各コンポーネントは `useContext(DataContext)` を通じてデータや更新関数を取得する。
  3.  ユーザーのアクション（例: `TimeEntry`でのフォーム送信）がトリガーとなり、更新関数が呼び出される。
  4.  `DataContext` 内の state が更新されると、そのデータに依存するすべてのコンポーネントが自動的に再レンダリングされる。

## 6. 主要なビジネスロジックと計算処理

### 6.1. 労働時間の計算

- `startTime`と`endTime`の差から総労働時間をミリ秒で算出。
- 時間単位に変換し、`breakMinutes`を分単位から時間単位に変換して差し引く。
- `Math.max(0, ...)` を使用し、計算結果が負の値にならないように保証する。

### 6.2. 給与計算

- **時給制 (`PayType.HOURLY`)**: `労働時間 × payRate (時給)`
- **月給制 (`PayType.MONTHLY`)**:
  - **日給の概算 (`AttendanceHistory`にて)**: `payRate (月給) / 22` (月の労働日数を 22 日と仮定)。出勤日に対してこの日給が適用される。
  - **月給 (`Payroll`にて)**: 労働時間に関わらず、`payRate (月給)` が固定で支払われる。

### 6.3. `AttendanceHistory`ページのデータ処理

1.  **レコードのフィルタリング**:
    - `attendanceRecords`全体から、選択されたユーザー ID (`selectedUserId`) と表示中の年月 (`currentDate`) に合致する記録のみを抽出する。
2.  **グラフデータの生成 (`useMemo`で最適化)**:
    - **棒グラフ (日次収益)**: フィルタリングされたレコードを日付順にソートし、各レコードについて日次収益を計算してグラフ用のデータ配列を生成する。
    - **ドーナツグラフ (目標達成度)**:
      - フィルタリングされたレコード全体の合計給与 (`totalSalary`) を算出。
      - 目標金額 (`monthlyGoal`) に対する合計給与の割合を計算。
      - `recharts`用に `{ name: 'Achieved', value: ... }` と `{ name: 'Remaining', value: ... }` の形式でデータを作成。
3.  **目標金額の管理 (`monthlyGoal`)**:
    - ユーザーの給与体系が月給制の場合、その月給 (`payRate`) をデフォルトの目標として設定。
    - 時給制の場合、またはユーザーが手動で変更したい場合のために、`Input`フィールドで目標金額を更新できる。

## 7. ルーティングとアクセス制御

### 7.1. ルーター

- **`HashRouter`**: サーバーサイドの設定が不要で、静的なホスティング環境でも機能するため採用。URL は `/#/path` の形式になる。

### 7.2. ルート構成 (`App.tsx`)

- `/login`: 認証されていないユーザー向けのログインページ。
- `/*`: 認証済みのユーザー向けのメインレイアウト (`MainLayout`)。
  - `MainLayout`内でさらにネストされたルーティングを定義。
  - `/admin/*`: 管理者専用ページ。

### 7.3. アクセス制御 (`ProtectedRoute.tsx`)

- **目的**: ページのアクセス権を制御するための高階コンポーネント。
- **機能**:
  1.  `AuthContext`から現在のユーザー情報を取得。
  2.  ユーザーが存在しない場合、`/login` にリダイレクト。
  3.  `allowedRoles` プロパティが指定されている場合、ユーザーのロールが許可されたロールに含まれているかチェック。
  4.  アクセスが許可されていない場合、ホームページ (`/`) にリダイレクト。
  5.  すべての条件をクリアした場合、子コンポーネントをレンダリング。

## 8. アクセシビリティ (A11Y) と UX

### 8.1. アクセシビリティへの配慮

- **セマンティック HTML**: `<header>`, `<main>`, `<aside>`, `<nav>`, `<table>`, `<th>` などの適切な HTML タグを使用し、文書構造を明確化。
- **フォーム**: すべての`Input`に`<label>`を関連付け、スクリーンリーダーがフォーム要素を正しく解釈できるようにする。
- **アイコンボタン**: 月移動の矢印ボタンなど、テキストラベルを持たないボタンには `aria-label` を追加し、その機能を説明。
- **動的コンテンツ**: `Payroll`ページの年月表示など、動的に変更されるコンテンツには `aria-live="polite"` を設定し、スクリーンリーダーに更新を穏やかに通知。
- **キーボードナビゲーション**: すべてのインタラクティブ要素（ボタン、リンク、フォーム）が Tab キーでフォーカス可能であり、`focus:ring` スタイルによってフォーカス状態が視覚的に明確になるように設計。

### 8.2. ユーザーエクスペリエンス (UX) の向上

- **視覚的フィードバック**:
  - `TimeEntry`フォーム送信後に成功メッセージを表示。
  - アクティブなナビゲーションリンクやボタンのホバー/フォーカス状態をスタイルで明示。
- **エラーハンドリング**:
  - ログイン失敗時に具体的なエラーメッセージを表示。
  - データが存在しない場合に「No records found」のようなメッセージを表示し、空の状態を明確に伝える。
- **操作の安全性**:
  - 管理者自身の削除を防ぐため、`UserManagement`で Admin ロールを持つユーザーの削除ボタンを無効化。
- **直感的な操作性**:
  - デフォルトのログイン情報を提供し、アプリケーションの評価を容易にする。
  - `AttendanceHistory`で目標金額をユーザーが直接設定できるようにし、柔軟性を提供。
  - グラフのツールチップで詳細なデータを表示し、情報の可読性を向上。
